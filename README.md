#PHP 基于debug_backtrace的流程日志与日志分析#

【依赖】apcu，用于做日志信息缓存，生成的流程日志并不会去直接落盘，大并发环境下频繁访问磁盘对硬盘不友好，所先到了100条的时候才触发一次写磁盘的逻辑；

利用`debug_backtrace`生成的一个流程日志，只要在任意的流程中调用这PL::instance()->set()方法，记做一个采样点，在业务流程中有多个采样点的话，会形成一个流程日志方便监控整个流程的运行状况;


初始日志格式为：

第一次流程	采样点1&采样点2&采样点3&采样点4&...
第二次流程	调用处1&采样点&2采样点3&采样点4&...

其中采样点描述为：
	callCount:调用次序|file:调用的文件|namespace:命名空间|function:调用方法|line:调用处的行号|time:调用发生的时间戳（微秒）|message:个人输入的信息（这个后面解释从哪里输入）

于是我们得到了一个初始化的日志，日志最终存在于一个文件中，并且这个流程日志支持多个流程，默认的流程名为defaultLine，当然我们可以设定子流程，这个后面说;

php业务是流程化的，我们拿第一次流程来说，采样点2的时间减去采样点1的时间戳，会得到第1步到第2步的运行时间，之后可以沿着这个思路直到组后一个采样点，得到一个从哪一步到哪一步的一个运行时间，所以这个日志还是有很多东西可以分析的；


###set方法###
PL::instance()->set(string $lineName = false, string $message = false) 	

第一个参数为子流程名，一个大的流程中可以包括更多的小流程，可以认为是一种理解方式，如果流程名为false，代表使用默认的流程名也就是defaultLine，否则将使用你自定义的流程名；

第二个参数为采样点的记录信息，可以自己写点啥，最好别太长，不能包括`|`和`&`这两个符号，否则影响日志分析；

###registerLines方法###
一段代码可能会是多个流程的复用，可能里面会有很多采样点，有你的，有我的，当然还有他的，但是我只想记录我的流程，怎么办呢，我弄了个开关：
	define('LINES_FILTER_CONTROLLER', false);       
平常是false代表关闭着着的，表示所有流程都会被记录下来，如果值为true则代表会对采样点过滤，在调用流程控制之前要先注册到底要监控哪几个流程，使用到了这个方法：
	PL::instance()->registerLines(array $input);
输入举例：
	array(
			PL::DEFAULTLINENAME=>false,     // 关闭主线，默认是存在且打开的，这个值就是defaultLine；
			'line2' => true,                // 打开line2线，表示记录命名为line2的采样点，其余没提到的或者false的，都忽略；
			'line3' => false,               // 关闭line3线，当然你不写也没问题，line3线照样是关闭的；

	);


###日志输出###
其实，日志我是按照天来输出的，并没有太大的策略，在StreamScanner.php平级目录下建立data目录，并赋予0777权限（你懂得...），会主动在这个目录下创建一个日期目录比如20161129，在这个目录下会创建出流程个数的流程日志，假如说我命名了两个流程，一个是默认的流程defaultLine，另一个line2，则会在这个地方生成两个文件defaultLine.data和line2.data；


###日志分析###
拿到原始日志，尝试进行了一次分析，文件所在目录直接执行`php parseData.php` ，会将data目录下日期文件夹下所有的data结尾的文件进行一次分析并得到.parse结尾的文件，比如上面的文件将命名为defaultLine.data.parse和line2.data.parse;

其日志格式为：（初始时间戳::调用次序:命名空间:方法名:行号）--到第二步的运行时间（百分比）--（调用次序:命名空间:方法名:行号）--...
举例如下：

	(1480420604::1:AAA:test:212)--0.00(75.01)--(2:BBB:test:226)--0.00(24.99)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.03)--(2:BBB:test:226)--0.00(24.97)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(59.99)--(2:BBB:test:226)--0.00(40.01)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.03)--(2:BBB:test:226)--0.00(24.97)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.03)--(2:BBB:test:226)--0.00(24.97)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.03)--(2:BBB:test:226)--0.00(24.97)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.01)--(2:BBB:test:226)--0.00(24.99)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.03)--(2:BBB:test:226)--0.00(24.97)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(75.01)--(2:BBB:test:226)--0.00(24.99)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420604::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420605::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420605::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
	(1480420605::1:AAA:test:212)--0.00(74.97)--(2:BBB:test:226)--0.00(25.03)--(3:BBB:test:228)
